<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GT Off-Campus Housing Map</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
        crossorigin="anonymous" />
    <style>
        :root {
            --gt-gold: #B3A369;
            --gt-navy: #003057;
            --light-gray: #f5f5f5;
            --shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--light-gray);
            height: 100vh;
            overflow: hidden;
        }

        /* Header */
        header {
            background-color: var(--gt-navy);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            z-index: 1000;
            position: relative;
        }

        .header-left h1 {
            color: var(--gt-gold);
            font-size: 24px;
            margin: 0;
        }

        .header-left p {
            margin: 2px 0 0 0;
            font-size: 14px;
        }



        /* Main container */
        .main-container {
            display: flex;
            height: calc(100vh - 70px);
        }

        /* Map container */
        .map-container {
            width: 66.67%;
            height: 100%;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        /* Listings panel */
        .listings-panel {
            width: 33.33%;
            height: 100%;
            background: white;
            overflow-y: auto;
            border-left: 1px solid #ddd;
        }

        /* Unified search and filter bar */
        .search-filter-bar {
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #ddd;
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            gap: 15px;
            align-items: flex-end;
        }

        .search-container {
            position: relative;
            flex: 1;
        }

        .search-input {
            width: 100%;
            padding: 10px 35px 10px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            transition: border-color 0.3s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--gt-gold);
            box-shadow: 0 0 0 2px rgba(179, 163, 105, 0.2);
        }

        .search-clear-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .search-clear-btn:hover {
            color: #333;
            background: #f0f0f0;
        }

        .controls-group {
            display: flex;
            align-items: flex-end;
            gap: 15px;
            flex-shrink: 0;
        }

        .sort-button-container {
            position: relative;
        }

        .sort-button {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: var(--gt-navy);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            min-width: 160px;
        }

        .sort-button:hover {
            background: var(--gt-gold);
            color: var(--gt-navy);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .sort-button .dropdown-arrow {
            transition: transform 0.3s ease;
        }

        .sort-button.active .dropdown-arrow {
            transform: rotate(180deg);
        }

        .sort-popup {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            margin-top: 4px;
            display: none;
        }

        .sort-popup.show {
            display: block;
        }

        .sort-option {
            padding: 12px 16px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            font-size: 14px;
            border-bottom: 1px solid #f0f0f0;
        }

        .sort-option:last-child {
            border-bottom: none;
        }

        .sort-option:hover {
            background: #f8f9fa;
        }

        .sort-option.active {
            background: var(--gt-gold);
            color: var(--gt-navy);
            font-weight: 600;
        }

        .map-filter-indicator {
            font-size: 12px;
            color: var(--gt-navy);
            font-weight: 500;
            padding: 4px 0;
            white-space: nowrap;
        }



        .filter-row {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .filter-row:last-of-type {
            margin-bottom: 0;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            min-width: 140px;
            flex: 1;
        }

        .filter-group label {
            font-size: 12px;
            font-weight: 600;
            color: var(--gt-navy);
            margin: 0;
        }

        .filter-select {
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            background: white;
            color: #333;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--gt-gold);
            box-shadow: 0 0 0 2px rgba(179, 163, 105, 0.2);
        }



        .sort-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            flex: 0 0 auto;
        }

        .sort-group label {
            font-size: 12px;
            font-weight: 600;
            color: var(--gt-navy);
            margin: 0;
        }



        .results-count {
            font-size: 12px;
            color: #666;
            font-weight: 500;
        }

        .listings-container {
            padding: 0;
        }

        /* Listing card */
        .listing-card {
            border-bottom: 1px solid #eee;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .listing-card:hover {
            background-color: var(--light-gray);
        }

        .listing-card.focused {
            background-color: #e3f2fd;
            border-left: 4px solid var(--gt-navy);
            padding-left: 16px;
        }

        .listing-name {
            font-size: 18px;
            font-weight: bold;
            color: var(--gt-navy);
            margin-bottom: 8px;
        }

        .listing-address {
            color: #666;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .listing-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .listing-bedrooms {
            font-size: 14px;
            color: #666;
        }

        .listing-price {
            font-size: 18px;
            font-weight: bold;
            color: var(--gt-navy);
        }

        .listing-phone {
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
        }

        .view-details-btn {
            background-color: var(--gt-navy);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.3s;
        }

        .view-details-btn:hover {
            background-color: var(--gt-gold);
        }

        /* Simple hover tooltip */
        .leaflet-tooltip {
            max-width: 250px !important;
            white-space: normal !important;
            word-wrap: break-word !important;
            font-size: 12px !important;
            line-height: 1.4 !important;
            padding: 8px !important;
            border-radius: 4px !important;
            box-shadow: var(--shadow) !important;
        }

        .simple-tooltip {
            max-width: 100%;
            font-size: 12px;
        }

        .simple-tooltip .tooltip-name {
            font-weight: bold;
            margin-bottom: 4px;
            word-wrap: break-word;
            line-height: 1.3;
        }

        .simple-tooltip .tooltip-address {
            color: #666;
            font-size: 11px;
            word-wrap: break-word;
            line-height: 1.2;
        }

        .campus-marker {
            background: none;
            border: none;
        }

        .campus-tooltip {
            font-size: 11px;
            font-weight: bold;
            padding: 2px 6px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            border: 1px solid #ccc;
            border-radius: 3px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .price-marker {
            background: none;
            border: none;
        }

        .price-tag {
            background: var(--gt-navy);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            text-align: center;
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            border: 2px solid white;
            min-width: 45px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .price-tag:hover {
            background: var(--gt-gold);
            color: var(--gt-navy);
            transform: scale(1.05);
        }

        #loading-status {
            position: fixed;
            bottom: 20px;
            left: 20px;
            padding: 10px 16px;
            background: var(--gt-navy);
            color: white;
            border-radius: 20px;
            z-index: 1000;
            box-shadow: var(--shadow);
            font-size: 12px;
        }

        @media (max-width: 1024px) {
            .main-container {
                flex-direction: column;
            }
            
            .map-container {
                width: 100%;
                height: 60%;
            }
            
            .listings-panel {
                width: 100%;
                height: 40%;
                border-left: none;
                border-top: 1px solid #ddd;
            }
            
            .search-filter-bar {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
            }
            
            .controls-group {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }
            
            .sort-button {
                width: 100%;
                min-width: auto;
                justify-content: center;
            }
        }

        /* Review Popup Styles */
        .review-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .review-popup.show {
            opacity: 1;
            visibility: visible;
        }

        .review-popup-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 450px;
            animation: popupSlideIn 0.3s ease;
        }

        @keyframes popupSlideIn {
            from {
                transform: scale(0.9) translateY(-20px);
                opacity: 0;
            }
            to {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }

        .popup-header {
            padding: 25px 25px 15px;
            border-bottom: 1px solid #e1e5e9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .popup-header h3 {
            color: var(--gt-navy);
            font-size: 20px;
            font-weight: 600;
            margin: 0;
        }

        .popup-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s ease;
        }

        .popup-close:hover {
            background: #f0f0f0;
        }

        .popup-body {
            padding: 20px 25px 30px;
            text-align: center;
        }

        .popup-body p {
            color: #666;
            margin-bottom: 25px;
            line-height: 1.5;
        }

        .popup-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .popup-btn {
            padding: 14px 20px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .popup-btn.primary {
            background: linear-gradient(135deg, var(--gt-navy), #1a4a72);
            color: white;
            border-color: var(--gt-navy);
        }

        .popup-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 48, 87, 0.3);
        }

        .popup-btn.secondary {
            background: white;
            color: var(--gt-navy);
            border-color: #e1e5e9;
        }

        .popup-btn.secondary:hover {
            background: #f8f9fa;
            border-color: var(--gt-gold);
        }

        /* Rating display styles */
        .listing-rating {
            margin: 8px 0;
            padding: 6px 0;
        }

        .rating-stars {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .star-rating {
            color: var(--gt-gold);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .review-count {
            color: #666;
            font-size: 12px;
            font-weight: 500;
        }

        .no-rating {
            color: #999;
            font-size: 12px;
            font-style: italic;
        }

        /* Map tooltip rating styles */
        .tooltip-rating {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #e0e0e0;
        }

        .tooltip-rating-value {
            color: var(--gt-gold);
            font-weight: 600;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <header>
        <div class="header-left">
            <h1>StingerSpaces</h1>
            <p>Georgia Tech Off-Campus Housing Finder</p>
        </div>
    </header>
    
    <div id="loading-status">Loading apartments...</div>
    
    <!-- Review Popup -->
    <div id="review-popup" class="review-popup">
        <div class="review-popup-content">
            <div class="popup-header">
                <h3>üè† Share Your Experience</h3>
                <button id="popup-close" class="popup-close">&times;</button>
            </div>
            <div class="popup-body">
                <p>Help other Georgia Tech students by sharing your apartment experience!</p>
                <div class="popup-buttons">
                    <button id="make-review-btn" class="popup-btn primary">Make a Review</button>
                    <button id="continue-browsing-btn" class="popup-btn secondary">Continue Browsing</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="main-container">
        <div class="map-container">
            <div id="map"></div>
        </div>
        
        <div class="listings-panel">
            <div class="search-filter-bar">
                <div class="search-container">
                    <input type="text" id="listings-search-input" class="search-input" placeholder="Search apartments...">
                    <button id="search-clear-btn" class="search-clear-btn" title="Clear search">√ó</button>
                </div>
                <div class="controls-group">
                    <div class="sort-button-container">
                        <button id="sort-button" class="sort-button">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M3 18h6v-2H3v2zM3 6v2h18V6H3zm0 7h12v-2H3v2z"/>
                            </svg>
                            <span id="sort-button-text">Name (A-Z)</span>
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor" class="dropdown-arrow">
                                <path d="M7 10l5 5 5-5z"/>
                            </svg>
                        </button>
                        <div id="sort-popup" class="sort-popup">
                            <div class="sort-option" data-value="name">Name (A-Z)</div>
                            <div class="sort-option" data-value="price-low">Price (Low to High)</div>
                            <div class="sort-option" data-value="price-high">Price (High to Low)</div>
                            <div class="sort-option" data-value="rating-high">User Rating (High to Low)</div>
                            <div class="sort-option" data-value="rating-low">User Rating (Low to High)</div>
                            <div class="sort-option" data-value="reviews-most">Most Reviews</div>
                            <div class="sort-option" data-value="distance-culc">Distance to CULC</div>
                            <div class="sort-option" data-value="distance-crc">Distance to CRC</div>
                            <div class="sort-option" data-value="distance-tech">Distance to Tech Square</div>
                            <div class="sort-option" data-value="distance-marta">Distance to MARTA</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="listings-container" id="listings-container">
                <!-- Listings will be populated here -->
            </div>
        </div>
    </div>

    <!-- Supabase JS -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin="anonymous"></script>
    <script>
        // Initialize the map centered on Georgia Tech
        const map = L.map('map').setView([33.7756, -84.3963], 14);
        const loadingStatus = document.getElementById('loading-status');

        // Add light monochrome tiles
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            maxZoom: 19,
            attribution: '¬© OpenStreetMap contributors, ¬© CARTO'
        }).addTo(map);

        // Add map event listeners for bounds-based filtering
        let mapUpdateTimeout;
        map.on('moveend zoomend', function() {
            // Debounce the update to avoid too many calls during rapid map changes
            clearTimeout(mapUpdateTimeout);
            mapUpdateTimeout = setTimeout(() => {
                if (apartmentsData.length > 0) {
                    updateListingsForMapView();
                }
            }, 300); // 300ms delay
        });

        // Helper function to delay execution
        const delay = ms => new Promise(resolve => setTimeout(resolve, ms));

        // Session storage key for geocoded addresses
        const GEOCACHE_KEY = 'stingerspaces_geocache';
        
        // Load geocache from session storage
        function loadGeoCache() {
            try {
                const cached = sessionStorage.getItem(GEOCACHE_KEY);
                return cached ? JSON.parse(cached) : {};
            } catch (error) {
                console.error('Error loading geocache:', error);
                return {};
            }
        }
        
        // Save geocache to session storage
        function saveGeoCache(cache) {
            try {
                sessionStorage.setItem(GEOCACHE_KEY, JSON.stringify(cache));
            } catch (error) {
                console.error('Error saving geocache:', error);
            }
        }
        
        // Helper function to try geocoding a single address
        async function tryGeocoding(address) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                if (data.length > 0) {
                    return {
                        lat: parseFloat(data[0].lat),
                        lon: parseFloat(data[0].lon)
                    };
                }
                return null;
            } catch (error) {
                console.error('Error geocoding:', address, error);
                return null;
            }
        }

        // Helper function to generate address variations for better geocoding success
        function getAddressVariations(address) {
            const variations = [];
            
            // Add NE/NW/SE/SW variations for Atlanta addresses
            if (address.includes('Atlanta') && !address.match(/\b(NE|NW|SE|SW)\b/)) {
                const baseAddr = address.replace(/,?\s*Atlanta.*$/, '');
                variations.push(`${baseAddr} NE, Atlanta, GA`);
                variations.push(`${baseAddr} NW, Atlanta, GA`);
                variations.push(`${baseAddr} SE, Atlanta, GA`);
                variations.push(`${baseAddr} SW, Atlanta, GA`);
            }
            
            // Try with "Avenue" instead of "Ave"
            if (address.includes(' Ave ') || address.includes(' Ave,')) {
                variations.push(address.replace(/ Ave /g, ' Avenue ').replace(/ Ave,/g, ' Avenue,'));
            }
            
            // Try with "Street" instead of "St"
            if (address.includes(' St ') || address.includes(' St,')) {
                variations.push(address.replace(/ St /g, ' Street ').replace(/ St,/g, ' Street,'));
            }
            
            // Try without zip code
            variations.push(address.replace(/,?\s*\d{5}(-\d{4})?$/, ''));
            
            return variations;
        }

        // Function to geocode address using Nominatim with caching
        async function geocodeAddress(address, currentIndex, totalCount) {
            try {
                const geoCache = loadGeoCache();
                
                // Check if we have cached coordinates
                if (geoCache[address]) {
                    loadingStatus.textContent = `Loading apartments ${currentIndex + 1}/${totalCount}`;
                    console.log('Using cached coordinates for:', address);
                    return geoCache[address];
                }
                
                // Add a delay before each geocoding request to avoid rate limiting
                await delay(1000);
                
                loadingStatus.textContent = `Geocoding ${currentIndex + 1}/${totalCount}`;
                console.log('Geocoding address:', address);
                
                // Try geocoding with original address first
                let coords = await tryGeocoding(address);
                
                // If that fails, try common address variations
                if (!coords) {
                    const variations = getAddressVariations(address);
                    for (const variation of variations) {
                        console.log('Trying address variation:', variation);
                        coords = await tryGeocoding(variation);
                        if (coords) break;
                        await delay(500); // Short delay between variations
                    }
                }
                
                if (coords) {
                    // Cache the successful result with the original address as key
                    geoCache[address] = coords;
                    saveGeoCache(geoCache);
                } else {
                    console.warn('No coordinates found for address:', address);
                    // Cache null result to avoid re-geocoding
                    geoCache[address] = null;
                    saveGeoCache(geoCache);
                }
                
                return coords;
            } catch (error) {
                console.error('Error geocoding address:', address, error);
                return null;
            }
        }

        // Function to create simple hover tooltip content
        function createTooltipContent(apartment) {
            const hasRatings = apartment.user_ratings && apartment.user_ratings.total_reviews > 0;
            const ratingContent = hasRatings ? 
                `<div class="tooltip-rating">
                    <div class="tooltip-rating-value">‚≠ê ${apartment.user_ratings.overall} (${apartment.user_ratings.total_reviews} reviews)</div>
                </div>` : 
                `<div class="tooltip-rating">
                    <div style="color: #999; font-size: 12px; font-style: italic;">No reviews yet</div>
                </div>`;

            return `
                <div class="simple-tooltip">
                    <div class="tooltip-name">${apartment.name}</div>
                    <div class="tooltip-address">${apartment.formatted_address}</div>
                    ${ratingContent}
                </div>
            `;
        }

        // Function to create listing card HTML
        function createListingCard(apartment, index) {
            // Create rating display
            const hasRatings = apartment.user_ratings && apartment.user_ratings.total_reviews > 0;
            const ratingDisplay = hasRatings ? 
                `<div class="listing-rating">
                    <div class="rating-stars">
                        <span class="star-rating">‚≠ê ${apartment.user_ratings.overall}</span>
                        <span class="review-count">(${apartment.user_ratings.total_reviews} review${apartment.user_ratings.total_reviews !== 1 ? 's' : ''})</span>
                    </div>
                </div>` : 
                `<div class="listing-rating">
                    <div class="rating-stars">
                        <span class="no-rating">No reviews yet</span>
                    </div>
                </div>`;

            return `
                <div class="listing-card" data-apartment-name="${apartment.name}" id="listing-${index}">
                    <div class="listing-name">${apartment.name}</div>
                    <div class="listing-address">${apartment.formatted_address}</div>
                    <div class="listing-phone">${apartment.phone}</div>
                    ${ratingDisplay}
                    <div class="listing-details">
                        <div class="listing-bedrooms">${apartment.bed_range}</div>
                        <div class="listing-price">${apartment.price_range}</div>
                    </div>
                    <button class="view-details-btn" onclick="viewApartmentDetails('${apartment.name}')">
                        View Details
                    </button>
                </div>
            `;
        }

        // Current filtered and sorted apartments
        let filteredApartments = [];

        // Extract price value from price range string
        function extractMinPrice(priceRange) {
            const match = priceRange.match(/\$(\d+(?:,\d+)?)/);
            return match ? parseInt(match[1].replace(',', '')) : 0;
        }

        // Extract max price from price range string
        function extractMaxPrice(priceRange) {
            const matches = priceRange.match(/\$(\d+(?:,\d+)?)/g);
            if (matches && matches.length > 1) {
                return parseInt(matches[1].replace(/[$,]/g, ''));
            }
            return extractMinPrice(priceRange);
        }

        // Get closest distance to campus from proximities
        function getClosestCampusDistance(apartment) {
            if (!apartment.proximities) return 999;
            
            const campusLocations = ['CULC', 'CRC', 'Tech Square', 'Student Center'];
            let minDistance = 999;
            
            campusLocations.forEach(location => {
                if (apartment.proximities[location]) {
                    minDistance = Math.min(minDistance, apartment.proximities[location].distance_miles);
                }
            });
            
            return minDistance;
        }

        // Sort apartments based on selected criteria
        function sortApartments(apartments, sortBy) {
            const sorted = [...apartments];
            
            switch (sortBy) {
                case 'name':
                    return sorted.sort((a, b) => a.name.localeCompare(b.name));
                    
                case 'price-low':
                    return sorted.sort((a, b) => extractMinPrice(a.price_range) - extractMinPrice(b.price_range));
                    
                case 'price-high':
                    return sorted.sort((a, b) => extractMinPrice(b.price_range) - extractMinPrice(a.price_range));
                    
                case 'distance-culc':
                    return sorted.sort((a, b) => {
                        const distA = a.proximities?.CULC?.distance_miles || 999;
                        const distB = b.proximities?.CULC?.distance_miles || 999;
                        return distA - distB;
                    });
                    
                case 'distance-crc':
                    return sorted.sort((a, b) => {
                        const distA = a.proximities?.CRC?.distance_miles || 999;
                        const distB = b.proximities?.CRC?.distance_miles || 999;
                        return distA - distB;
                    });
                    
                case 'distance-tech':
                    return sorted.sort((a, b) => {
                        const distA = a.proximities?.['Tech Square']?.distance_miles || 999;
                        const distB = b.proximities?.['Tech Square']?.distance_miles || 999;
                        return distA - distB;
                    });
                    
                case 'distance-marta':
                    return sorted.sort((a, b) => {
                        const distA = a.proximities?.MARTA?.distance_miles || 999;
                        const distB = b.proximities?.MARTA?.distance_miles || 999;
                        return distA - distB;
                    });
                    
                case 'rating-high':
                    return sorted.sort((a, b) => {
                        const ratingA = a.user_ratings?.overall || 0;
                        const ratingB = b.user_ratings?.overall || 0;
                        return ratingB - ratingA; // Higher ratings first
                    });
                    
                case 'rating-low':
                    return sorted.sort((a, b) => {
                        const ratingA = a.user_ratings?.overall || 0;
                        const ratingB = b.user_ratings?.overall || 0;
                        return ratingA - ratingB; // Lower ratings first
                    });
                    
                case 'reviews-most':
                    return sorted.sort((a, b) => {
                        const reviewsA = a.user_ratings?.total_reviews || 0;
                        const reviewsB = b.user_ratings?.total_reviews || 0;
                        return reviewsB - reviewsA; // Most reviews first
                    });
                    
                default:
                    return sorted;
            }
        }

        // Filter apartments based on criteria
        function filterApartments(apartments, filters) {
            return apartments.filter(apartment => {
                // Search filter
                if (filters.search) {
                    const searchLower = filters.search.toLowerCase();
                    const matchesSearch = 
                        apartment.name.toLowerCase().includes(searchLower) ||
                        apartment.formatted_address.toLowerCase().includes(searchLower);
                    if (!matchesSearch) return false;
                }
                
                // Map bounds filter (when enabled)
                if (useMapBounds && apartment.coordinates && apartment.coordinates.length === 2) {
                    const bounds = map.getBounds();
                    const [lat, lon] = apartment.coordinates;
                    const point = L.latLng(lat, lon);
                    if (!bounds.contains(point)) return false;
                }
                
                return true;
            });
        }

        // Function to update listings based on current map view
        function updateListingsForMapView() {
            if (apartmentsData.length === 0) return;
            
            // Use the populateListings function with map bounds enabled
            populateListings(true);
        }

        // Get current filter values
        function getCurrentFilters() {
            return {
                search: document.getElementById('listings-search-input')?.value || ''
            };
        }



        // Function to populate listings panel with filtering and sorting
        function populateListings(enableMapBounds = false) {
            const sortBy = currentSortBy;
            const filters = getCurrentFilters();
            
            // Set map bounds filtering based on parameter
            useMapBounds = enableMapBounds;
            
            // Update indicator visibility
            const indicator = document.getElementById('map-filter-indicator');
            if (indicator) {
                indicator.style.display = enableMapBounds ? 'block' : 'none';
            }
            
            // Filter apartments
            filteredApartments = filterApartments(apartmentsData, filters);
            
            // Sort apartments
            filteredApartments = sortApartments(filteredApartments, sortBy);
            
            // Update display
            const listingsContainer = document.getElementById('listings-container');
            if (filteredApartments.length === 0) {
                const message = enableMapBounds ? 
                    `<div style="padding: 40px 20px; text-align: center; color: #666;">
                        <h3>No apartments in current view</h3>
                        <p>Zoom out or pan the map to see more apartments.</p>
                    </div>` :
                    `<div style="padding: 40px 20px; text-align: center; color: #666;">
                        <h3>No apartments found</h3>
                        <p>Try adjusting your search terms.</p>
                    </div>`;
                listingsContainer.innerHTML = message;
            } else {
                listingsContainer.innerHTML = filteredApartments
                    .map((apartment, index) => createListingCard(apartment, index))
                    .join('');
                
                // Add click handlers to listing cards
                document.querySelectorAll('.listing-card').forEach(card => {
                    card.addEventListener('click', function(e) {
                        if (!e.target.classList.contains('view-details-btn')) {
                            const apartmentName = this.dataset.apartmentName;
                            focusApartmentFromListing(apartmentName);
                        }
                    });
                });
            }
            
            // Update map markers to show only filtered apartments
            updateMapMarkers();
        }

        // Campus locations with coordinates
        const campusLocations = {
            'CULC': { lat: 33.7748, lon: -84.3968, name: 'CULC', color: '#b3a369' },
            'CRC': { lat: 33.7757, lon: -84.4036, name: 'Campus Recreation Center', color: '#003057' },
            'Tech Square': { lat: 33.7772, lon: -84.3899, name: 'Tech Square', color: '#a4925a' },
            'Student Center': { lat: 33.7738, lon: -84.3985, name: 'Student Center', color: '#8a8b8c' },
            'MARTA': { lat: 33.7802, lon: -84.3886, name: 'Midtown MARTA Station', color: '#e31837' }
        };

        // Update map markers based on filtered apartments
        function updateMapMarkers() {
            // Clear existing markers but keep campus markers
            map.eachLayer(layer => {
                if (layer instanceof L.Marker && !layer.isCampusMarker) {
                    map.removeLayer(layer);
                }
            });
            
            // Add markers for filtered apartments
            filteredApartments.forEach(apartment => {
                if (apartment.coordinates && apartment.coordinates.length === 2) {
                    const [lat, lon] = apartment.coordinates;
                    
                    // Create price tag marker
                    const minPrice = extractMinPrice(apartment.price_range);
                    const priceText = minPrice > 0 ? `$${minPrice.toLocaleString()}+` : '$?';
                    
                    const priceIcon = L.divIcon({
                        className: 'price-marker',
                        html: `<div class="price-tag">${priceText}</div>`,
                        iconSize: [60, 24],
                        iconAnchor: [30, 12]
                    });
                    
                    const marker = L.marker([lat, lon], { icon: priceIcon })
                        .bindTooltip(createTooltipContent(apartment), {
                            permanent: false,
                            direction: 'top',
                            offset: [0, -5],
                            opacity: 0.9,
                            className: 'simple-tooltip'
                        })
                        .addTo(map);
                    
                    marker.on('click', () => {
                        focusApartmentFromMap(apartment.name);
                    });
                }
            });
        }

        // Add campus location markers
        function addCampusMarkers() {
            Object.values(campusLocations).forEach(location => {
                const campusIcon = L.divIcon({
                    className: 'campus-marker',
                    html: `<div style="background-color: ${location.color}; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 4px rgba(0,0,0,0.3);"></div>`,
                    iconSize: [16, 16],
                    iconAnchor: [8, 8]
                });

                const marker = L.marker([location.lat, location.lon], { icon: campusIcon })
                    .bindTooltip(location.name, {
                        permanent: false,
                        direction: 'top',
                        offset: [0, -10],
                        className: 'campus-tooltip'
                    })
                    .addTo(map);
                
                marker.isCampusMarker = true;
            });
        }

        // Function to focus apartment from map marker click
        function focusApartmentFromMap(apartmentName) {
            // Remove focus from all listings
            document.querySelectorAll('.listing-card').forEach(card => {
                card.classList.remove('focused');
            });
            
            // Find and focus the corresponding listing
            const targetCard = document.querySelector(`[data-apartment-name="${apartmentName}"]`);
            if (targetCard) {
                targetCard.classList.add('focused');
                targetCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // Function to focus apartment from listing click
        function focusApartmentFromListing(apartmentName) {
            const apartment = apartmentsData.find(apt => apt.name === apartmentName);
            if (apartment && apartment.coordinates && apartment.coordinates.length === 2) {
                // Center map on apartment
                const [lat, lon] = apartment.coordinates;
                map.setView([lat, lon], 16);
                
                // Focus the listing card
                document.querySelectorAll('.listing-card').forEach(card => {
                    card.classList.remove('focused');
                });
                const targetCard = document.querySelector(`[data-apartment-name="${apartmentName}"]`);
                if (targetCard) {
                    targetCard.classList.add('focused');
                }
            }
        }

        // Function to view apartment details (navigate to detail page)
        function viewApartmentDetails(apartmentName) {
            // Create URL with apartment name as parameter
            const encodedName = encodeURIComponent(apartmentName);
            window.open(`apartment-details.html?apartment=${encodedName}`, '_blank');
        }

        // Load apartment ratings from Supabase
        async function loadApartmentRatings() {
            try {
                console.log('Loading apartment ratings from Supabase...');
                loadingStatus.textContent = 'Loading ratings data...';
                
                // Wait for Supabase client to be available
                const waitForSupabase = () => {
                    return new Promise((resolve) => {
                        const checkSupabase = () => {
                            if (window.supabaseClient) {
                                resolve();
                            } else {
                                setTimeout(checkSupabase, 100);
                            }
                        };
                        checkSupabase();
                    });
                };
                
                await waitForSupabase();
                
                // Fetch apartment ratings summary
                const { data: ratingsData, error } = await window.supabaseClient
                    .from('apartment_ratings_summary')
                    .select('*');
                
                if (error) {
                    console.error('Error fetching ratings data:', error);
                    return;
                }
                
                console.log(`Loaded ratings for ${ratingsData.length} apartments`);
                
                // Create a map for quick lookup
                const ratingsMap = {};
                ratingsData.forEach(rating => {
                    ratingsMap[rating.apartment_name] = rating;
                });
                
                // Merge ratings with apartment data
                apartmentsData.forEach(apartment => {
                    const ratings = ratingsMap[apartment.name];
                    if (ratings) {
                        apartment.user_ratings = {
                            overall: Math.round(ratings.avg_overall_rating * 10) / 10,
                            safety: Math.round(ratings.avg_safety_rating * 10) / 10,
                            proximity_grocery: Math.round(ratings.avg_proximity_grocery_rating * 10) / 10,
                            maintenance: Math.round(ratings.avg_maintenance_rating * 10) / 10,
                            management: Math.round(ratings.avg_management_rating * 10) / 10,
                            amenities: Math.round(ratings.avg_amenities_rating * 10) / 10,
                            total_reviews: ratings.total_reviews
                        };
                    } else {
                        apartment.user_ratings = {
                            overall: 0,
                            safety: 0,
                            proximity_grocery: 0,
                            maintenance: 0,
                            management: 0,
                            amenities: 0,
                            total_reviews: 0
                        };
                    }
                });
                
            } catch (error) {
                console.error('Error loading apartment ratings:', error);
                // Continue without ratings if there's an error
            }
        }

        // Load and process apartment data
        let apartmentsData = [];
        let currentSortBy = 'name';
        let useMapBounds = false; // Flag to enable/disable map bounds filtering
        async function loadApartments() {
            try {
                console.log('Starting to load apartment data...');
                loadingStatus.textContent = 'Loading apartment data...';
                
                const response = await fetch('apartment_data.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                apartmentsData = await response.json();
                console.log(`Loaded ${apartmentsData.length} apartments`);
                
                // Load ratings data from Supabase if available
                await loadApartmentRatings();
                
                // Initialize filtered apartments with all apartments
                filteredApartments = [...apartmentsData];
                
                // Populate the listings panel
                populateListings();
                
                loadingStatus.textContent = `‚úÖ Loaded ${apartmentsData.length} apartments`;
                setTimeout(() => {
                    loadingStatus.style.display = 'none';
                }, 2000);
                
                return true; // Success
                
            } catch (error) {
                console.error('Error loading apartment data:', error);
                loadingStatus.textContent = '‚ùå Error loading apartments';
                loadingStatus.style.backgroundColor = '#d32f2f';
                return false; // Failed
            }
        }

        // Initialize search and filter functionality
        function initializeFilters() {
            const searchInput = document.getElementById('listings-search-input');
            const clearBtn = document.getElementById('search-clear-btn');
            const sortButton = document.getElementById('sort-button');
            const sortPopup = document.getElementById('sort-popup');
            const sortButtonText = document.getElementById('sort-button-text');

            // Hide clear button initially
            clearBtn.style.display = 'none';

            // Update clear button visibility based on search input
            function updateClearButtonVisibility() {
                clearBtn.style.display = searchInput.value.length > 0 ? 'flex' : 'none';
            }

            // Update sort button text and active option
            function updateSortButton(value, text) {
                currentSortBy = value;
                sortButtonText.textContent = text;
                
                // Update active state in popup
                document.querySelectorAll('.sort-option').forEach(option => {
                    option.classList.toggle('active', option.dataset.value === value);
                });
                
                populateListings();
            }

            // Search input handler
            searchInput.addEventListener('input', function() {
                updateClearButtonVisibility();
                populateListings();
                updateMapMarkers();
            });

            // Clear search button
            clearBtn.addEventListener('click', function() {
                searchInput.value = '';
                updateClearButtonVisibility();
                populateListings();
                updateMapMarkers();
                searchInput.focus();
            });

            // Sort button toggle
            sortButton.addEventListener('click', function(e) {
                e.stopPropagation();
                sortPopup.classList.toggle('show');
                sortButton.classList.toggle('active');
            });

            // Sort option selection
            document.querySelectorAll('.sort-option').forEach(option => {
                option.addEventListener('click', function() {
                    const value = this.dataset.value;
                    const text = this.textContent;
                    updateSortButton(value, text);
                    sortPopup.classList.remove('show');
                    sortButton.classList.remove('active');
                });
            });

            // Close popup when clicking outside
            document.addEventListener('click', function(e) {
                if (!sortButton.contains(e.target) && !sortPopup.contains(e.target)) {
                    sortPopup.classList.remove('show');
                    sortButton.classList.remove('active');
                }
            });

            // Initialize active sort option
            updateSortButton('name', 'Name (A-Z)');
        }        // Initialize the map with apartments
        loadApartments().then(() => {
            // Initialize search and filters after apartments are loaded
            initializeFilters();
            addCampusMarkers();
            updateMapMarkers();
        });


    </script>
    
    <!-- Authentication integration -->
    <script src="auth/js/auth-config.js"></script>
    <script src="auth/js/main-app-auth.js"></script>
    
    <!-- Review popup -->
    <script src="js/review-popup.js"></script>
</body>
</html>